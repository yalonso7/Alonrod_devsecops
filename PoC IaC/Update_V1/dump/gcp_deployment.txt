imports:
  - path: test-config.yaml

resources:
  # VPC Network
  - name: test-network
    type: compute.v1.network
    properties:
      autoCreateSubnetworks: false
      description: Test VPC network for scanning

  # Subnet
  - name: test-subnet
    type: compute.v1.subnetwork
    properties:
      region: us-central1
      network: $(ref.test-network.selfLink)
      ipCidrRange: 10.0.0.0/24
      privateIpGoogleAccess: false  # Issue: Private Google access disabled

  # Firewall rule - SSH open to world
  - name: allow-ssh-from-anywhere
    type: compute.v1.firewall
    properties:
      network: $(ref.test-network.selfLink)
      priority: 1000
      direction: INGRESS
      sourceRanges:
        - 0.0.0.0/0  # Issue: SSH open to internet
      allowed:
        - IPProtocol: tcp
          ports:
            - '22'

  # Firewall rule - RDP open to world
  - name: allow-rdp-from-anywhere
    type: compute.v1.firewall
    properties:
      network: $(ref.test-network.selfLink)
      priority: 1000
      direction: INGRESS
      sourceRanges:
        - 0.0.0.0/0  # Issue: RDP open to internet
      allowed:
        - IPProtocol: tcp
          ports:
            - '3389'

  # Firewall rule - Allow all egress
  - name: allow-all-egress
    type: compute.v1.firewall
    properties:
      network: $(ref.test-network.selfLink)
      priority: 1000
      direction: EGRESS
      destinationRanges:
        - 0.0.0.0/0
      allowed:
        - IPProtocol: all

  # Compute Instance with issues
  - name: test-vm-instance
    type: compute.v1.instance
    properties:
      zone: us-central1-a
      machineType: zones/us-central1-a/machineTypes/n1-standard-1
      disks:
        - deviceName: boot
          type: PERSISTENT
          boot: true
          autoDelete: true
          initializeParams:
            sourceImage: projects/debian-cloud/global/images/family/debian-11
            diskSizeGb: 10
            diskType: zones/us-central1-a/diskTypes/pd-standard
            # Issue: Disk encryption not configured
      networkInterfaces:
        - network: $(ref.test-network.selfLink)
          subnetwork: $(ref.test-subnet.selfLink)
          accessConfigs:
            - name: External NAT
              type: ONE_TO_ONE_NAT  # Issue: Public IP assigned
      serviceAccounts:
        - email: default
          scopes:
            - https://www.googleapis.com/auth/cloud-platform  # Issue: Overly broad scope
      metadata:
        items:
          - key: startup-script
            value: |
              #!/bin/bash
              export API_KEY="hardcoded-key-12345"  # Issue: Hardcoded secret
              echo "admin:password123" > /tmp/creds.txt  # Issue: Hardcoded credentials
      # Issue: No shielded VM configuration
      # Issue: Serial port enabled by default

  # Cloud Storage Bucket with issues
  - name: test-storage-bucket
    type: storage.v1.bucket
    properties:
      location: US
      storageClass: STANDARD
      iamConfiguration:
        uniformBucketLevelAccess:
          enabled: false  # Issue: Uniform access not enabled
      # Issue: No versioning enabled
      # Issue: No lifecycle rules
      # Issue: Public access possible

  # Storage Bucket IAM binding - public access
  - name: bucket-public-access
    type: storage.v1.bucket
    properties:
      bucket: $(ref.test-storage-bucket.name)
      entity: allUsers
      role: READER  # Issue: Bucket publicly readable

  # Cloud SQL Instance without proper security
  - name: test-sql-instance
    type: sqladmin.v1beta4.instance
    properties:
      region: us-central1
      databaseVersion: MYSQL_8_0
      settings:
        tier: db-f1-micro
        backupConfiguration:
          enabled: false  # Issue: Backups disabled
          binaryLogEnabled: false
        ipConfiguration:
          ipv4Enabled: true
          authorizedNetworks:
            - value: 0.0.0.0/0  # Issue: Database accessible from anywhere
              name: allow-all
          requireSsl: false  # Issue: SSL not required
        # Issue: No automatic storage increase
        databaseFlags:
          - name: local_infile
            value: 'on'  # Issue: Potentially insecure flag

  # SQL Database
  - name: test-database
    type: sqladmin.v1beta4.database
    properties:
      instance: $(ref.test-sql-instance.name)
      name: testdb
      charset: utf8mb4

  # SQL User with weak configuration
  - name: test-sql-user
    type: sqladmin.v1beta4.user
    properties:
      instance: $(ref.test-sql-instance.name)
      name: admin
      password: WeakPassword123  # Issue: Weak password in config
      host: '%'  # Issue: User can connect from anywhere

  # Cloud Function without proper configuration
  - name: test-cloud-function
    type: gcp-types/cloudfunctions-v1:projects.locations.functions
    properties:
      parent: projects/[PROJECT_ID]/locations/us-central1
      function: test-function
      runtime: python39
      entryPoint: hello_world
      httpsTrigger: {}  # Issue: Unauthenticated HTTP trigger
      environmentVariables:
        API_KEY: hardcoded-api-key-67890  # Issue: Hardcoded secret
        DB_PASSWORD: admin123  # Issue: Hardcoded database password
      # Issue: No VPC connector
      # Issue: No service account specified (uses default)

  # IAM Service Account with broad permissions
  - name: test-service-account
    type: iam.v1.serviceAccount
    properties:
      accountId: test-service-account
      displayName: Test Service Account

  # IAM Policy Binding - Owner role
  - name: overly-permissive-binding
    type: gcp-types/cloudresourcemanager-v1:virtual.projects.iamMemberBinding
    properties:
      resource: [PROJECT_ID]
      role: roles/owner  # Issue: Owner role assigned
      member: serviceAccount:$(ref.test-service-account.email)

  # Pub/Sub Topic without encryption
  - name: test-pubsub-topic
    type: pubsub.v1.topic
    properties:
      topic: test-topic
      # Issue: No customer-managed encryption key

  # BigQuery Dataset
  - name: test-bigquery-dataset
    type: bigquery.v2.dataset
    properties:
      datasetReference:
        datasetId: test_dataset
      location: US
      access:
        - role: READER
          specialGroup: allAuthenticatedUsers  # Issue: Accessible to all authenticated users
      # Issue: No default encryption specified
      # Issue: No expiration time

  # KMS Crypto Key (but not used)
  - name: test-kms-keyring
    type: gcp-types/cloudkms-v1:projects.locations.keyRings
    properties:
      parent: projects/[PROJECT_ID]/locations/us-central1
      keyRingId: test-keyring

  - name: test-crypto-key
    type: gcp-types/cloudkms-v1:projects.locations.keyRings.cryptoKeys
    properties:
      parent: $(ref.test-kms-keyring.name)
      cryptoKeyId: test-key
      purpose: ENCRYPT_DECRYPT
      rotationPeriod: 31536000s  # Issue: Rotation period too long (365 days)

outputs:
  - name: networkName
    value: $(ref.test-network.name)
  - name: instanceName
    value: $(ref.test-vm-instance.name)
  - name: bucketName
    value: $(ref.test-storage-bucket.name)
  - name: sqlInstanceName
    value: $(ref.test-sql-instance.name)