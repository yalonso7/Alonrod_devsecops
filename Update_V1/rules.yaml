rules:
  # AWS Security Rules
  - id: "AWS-S3-001"
    name: "S3 Bucket Public Access"
    severity: "critical"
    provider: "aws"
    resource_type: "aws_s3_bucket"
    pattern: 'resource\s+"aws_s3_bucket"\s+"[^"]+"\s*{[^}]*acl\s*=\s*"public-read'
    owasp: ["A01:2021-Broken Access Control", "A05:2021-Security Misconfiguration"]
    csa_ccm: ["IAM-02", "DSI-02", "GRM-06"]
    description: "S3 bucket allows public read access"
    recommendation: "Remove public ACL. Use bucket policies with principle of least privilege. Enable S3 Block Public Access."

  - id: "AWS-S3-002"
    name: "S3 Bucket Encryption Disabled"
    severity: "high"
    provider: "aws"
    resource_type: "aws_s3_bucket"
    pattern: 'resource\s+"aws_s3_bucket"\s+"([^"]+)"\s*{(?:(?!server_side_encryption_configuration).)*?'
    owasp: ["A02:2021-Cryptographic Failures"]
    csa_ccm: ["EKM-01", "EKM-02", "DSI-01"]
    description: "S3 bucket does not have encryption enabled"
    recommendation: "Enable server-side encryption using aws_s3_bucket_server_side_encryption_configuration with AES256 or aws:kms."

  - id: "AWS-EC2-001"
    name: "EC2 Instance Public IP"
    severity: "high"
    provider: "aws"
    resource_type: "aws_instance"
    pattern: 'associate_public_ip_address\s*=\s*true'
    owasp: ["A01:2021-Broken Access Control", "A05:2021-Security Misconfiguration"]
    csa_ccm: ["IVS-01", "IAM-09"]
    description: "EC2 instance has public IP enabled"
    recommendation: "Avoid public IPs. Use NAT Gateway or VPN for outbound access. Place instances in private subnets."

  - id: "AWS-SG-001"
    name: "Security Group Unrestricted Ingress"
    severity: "critical"
    provider: "aws"
    resource_type: "aws_security_group"
    pattern: 'cidr_blocks\s*=\s*\[\s*"0\.0\.0\.0/0"\s*\]'
    owasp: ["A01:2021-Broken Access Control", "A05:2021-Security Misconfiguration"]
    csa_ccm: ["IVS-01", "IVS-02", "IAM-09"]
    description: "Security group allows unrestricted ingress (0.0.0.0/0)"
    recommendation: "Restrict ingress to specific IP ranges. Use least privilege principle for network access."

  - id: "AWS-RDS-001"
    name: "RDS Instance Not Encrypted"
    severity: "high"
    provider: "aws"
    resource_type: "aws_db_instance"
    pattern: 'resource\s+"aws_db_instance"\s+"([^"]+)"\s*{(?:(?!storage_encrypted\s*=\s*true).)*?'
    owasp: ["A02:2021-Cryptographic Failures"]
    csa_ccm: ["EKM-01", "EKM-02", "DSI-01"]
    description: "RDS instance does not have encryption enabled"
    recommendation: "Enable storage_encrypted = true and specify kms_key_id for encryption at rest."

  - id: "AWS-RDS-002"
    name: "RDS Publicly Accessible"
    severity: "critical"
    provider: "aws"
    resource_type: "aws_db_instance"
    pattern: 'publicly_accessible\s*=\s*true'
    owasp: ["A01:2021-Broken Access Control"]
    csa_ccm: ["IAM-02", "DSI-02"]
    description: "RDS instance is publicly accessible"
    recommendation: "Set publicly_accessible = false. Use private subnets and VPN/bastion for access."

  - id: "AWS-IAM-001"
    name: "IAM Policy Wildcard Actions"
    severity: "high"
    provider: "aws"
    resource_type: "aws_iam_policy"
    pattern: '"Action"\s*:\s*"[*]"'
    owasp: ["A01:2021-Broken Access Control"]
    csa_ccm: ["IAM-01", "IAM-02", "IAM-08"]
    description: "IAM policy allows wildcard (*) actions"
    recommendation: "Use specific actions instead of wildcards. Follow least privilege principle."

  - id: "AWS-LOG-001"
    name: "CloudWatch Logs Not Configured"
    severity: "medium"
    provider: "aws"
    resource_type: "aws_instance"
    pattern: 'resource\s+"aws_instance"\s+"([^"]+)"\s*{(?:(?!cloudwatch).)*?'
    owasp: ["A09:2021-Security Logging and Monitoring Failures"]
    csa_ccm: ["LOG-01", "LOG-02", "SEF-01"]
    description: "Instance does not have CloudWatch logging configured"
    recommendation: "Configure CloudWatch Logs for monitoring and auditing. Enable detailed monitoring."

  # GCP Security Rules
  - id: "GCP-GCS-001"
    name: "GCS Bucket Public Access"
    severity: "critical"
    provider: "gcp"
    resource_type: "google_storage_bucket"
    pattern: 'role\s*=\s*"roles/storage\.objectViewer"\s*\n\s*members\s*=\s*\[\s*"allUsers"'
    owasp: ["A01:2021-Broken Access Control", "A05:2021-Security Misconfiguration"]
    csa_ccm: ["IAM-02", "DSI-02", "GRM-06"]
    description: "GCS bucket allows public access"
    recommendation: "Remove allUsers and allAuthenticatedUsers from IAM bindings. Use specific service accounts."

  - id: "GCP-GCS-002"
    name: "GCS Bucket Encryption Not Configured"
    severity: "high"
    provider: "gcp"
    resource_type: "google_storage_bucket"
    pattern: 'resource\s+"google_storage_bucket"\s+"([^"]+)"\s*{(?:(?!encryption).)*?'
    owasp: ["A02:2021-Cryptographic Failures"]
    csa_ccm: ["EKM-01", "EKM-02", "DSI-01"]
    description: "GCS bucket does not have customer-managed encryption"
    recommendation: "Configure encryption block with default_kms_key_name for CMEK encryption."

  - id: "GCP-GCE-001"
    name: "GCE Instance External IP"
    severity: "high"
    provider: "gcp"
    resource_type: "google_compute_instance"
    pattern: 'access_config\s*{'
    owasp: ["A01:2021-Broken Access Control", "A05:2021-Security Misconfiguration"]
    csa_ccm: ["IVS-01", "IAM-09"]
    description: "GCE instance has external IP address"
    recommendation: "Remove access_config block. Use Cloud NAT or Identity-Aware Proxy for access."

  - id: "GCP-FW-001"
    name: "Firewall Rule Allows All"
    severity: "critical"
    provider: "gcp"
    resource_type: "google_compute_firewall"
    pattern: 'source_ranges\s*=\s*\[\s*"0\.0\.0\.0/0"\s*\]'
    owasp: ["A01:2021-Broken Access Control", "A05:2021-Security Misconfiguration"]
    csa_ccm: ["IVS-01", "IVS-02", "IAM-09"]
    description: "Firewall rule allows traffic from anywhere (0.0.0.0/0)"
    recommendation: "Restrict source_ranges to specific IP ranges. Use Identity-Aware Proxy where possible."

  - id: "GCP-SQL-001"
    name: "Cloud SQL Not Encrypted"
    severity: "high"
    provider: "gcp"
    resource_type: "google_sql_database_instance"
    pattern: 'resource\s+"google_sql_database_instance"\s+"([^"]+)"\s*{(?:(?!encryption_key_name).)*?'
    owasp: ["A02:2021-Cryptographic Failures"]
    csa_ccm: ["EKM-01", "EKM-02", "DSI-01"]
    description: "Cloud SQL instance not using customer-managed encryption key"
    recommendation: "Configure encryption_key_name for CMEK. Enable automated backups with encryption."

  - id: "GCP-SQL-002"
    name: "Cloud SQL Public IP"
    severity: "critical"
    provider: "gcp"
    resource_type: "google_sql_database_instance"
    pattern: 'ip_configuration\s*{[^}]*ipv4_enabled\s*=\s*true'
    owasp: ["A01:2021-Broken Access Control"]
    csa_ccm: ["IAM-02", "DSI-02"]
    description: "Cloud SQL instance has public IP enabled"
    recommendation: "Set ipv4_enabled = false. Use Private IP and Cloud SQL Proxy for secure access."

  - id: "GCP-LOG-001"
    name: "GCE No Logging Configured"
    severity: "medium"
    provider: "gcp"
    resource_type: "google_compute_instance"
    pattern: 'resource\s+"google_compute_instance"\s+"([^"]+)"\s*{(?:(?!logging).)*?'
    owasp: ["A09:2021-Security Logging and Monitoring Failures"]
    csa_ccm: ["LOG-01", "LOG-02", "SEF-01"]
    description: "GCE instance does not have logging configured"
    recommendation: "Enable Cloud Logging and Cloud Monitoring. Configure log sinks for security events."

  # Cross-Provider Rules
  - id: "GEN-001"
    name: "Hardcoded Secrets"
    severity: "critical"
    provider: "all"
    resource_type: "all"
    pattern: '(password|secret|api_key|token)\s*=\s*"[^$]'
    owasp: ["A07:2021-Identification and Authentication Failures"]
    csa_ccm: ["IAM-01", "EKM-03", "GRM-01"]
    description: "Hardcoded secrets found in configuration"
    recommendation: "Use secrets management services (AWS Secrets Manager, GCP Secret Manager). Reference secrets via variables."

  - id: "GEN-002"
    name: "Missing Resource Tags"
    severity: "low"
    provider: "all"
    resource_type: "all"
    pattern: 'resource\s+"(?:aws_|google_)[^"]+"\s+"([^"]+)"\s*{(?:(?!tags).)*?'
    owasp: ["A05:2021-Security Misconfiguration"]
    csa_ccm: ["GRM-06", "GRM-08"]
    description: "Resource missing required tags/labels for governance"
    recommendation: "Add tags/labels for Environment, Owner, CostCenter, and DataClassification for proper governance."
