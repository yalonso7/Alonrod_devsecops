# Sample Prisma Cloud WAAS Policy Configuration
# This file provides a complete example of WAAS policy configuration
# that can be deployed using deploy_waas_policy.py

apiVersion: waas.prismacloud.io/v1
kind: WAASPolicy

metadata:
  name: production-api-protection
  description: Production API protection with OWASP Top 10 and API security controls
  labels:
    environment: production
    criticality: high
    team: security-ops
  version: 1.0.0

spec:
  # Define which applications this policy applies to
  appScope:
    # Applications can be specified by name or wildcard
    applications:
      - customer-api
      - payment-api
      - mobile-backend
    
    # Or use environments/collections
    environments:
      - production
    
    # Optional: Use labels for more granular selection
    labels:
      waas-enabled: "true"
      api-protection: "strict"
  
  # Protection mode: alert, prevent, or ban
  protectionMode: prevent
  
  # Define rulesets (can have multiple with different priorities)
  rulesets:
    - name: production-protection
      priority: 1
      
      # HTTP/OWASP Top 10 Protection
      httpProtection:
        enabled: true
        
        # SQL Injection Protection
        sqli: prevent
        
        # Cross-Site Scripting (XSS)
        xss: prevent
        
        # Command Injection
        cmdi: prevent
        
        # Code Injection
        codeInjection: prevent
        
        # Local File Inclusion
        lfi: prevent
        
        # Attack Tools Detection (scanners, fuzzing tools)
        attackTools: prevent
        
        # Shellshock Protection
        shellshock: prevent
        
        # Malformed Request Protection
        malformedRequest: prevent
        
        # XML External Entity (XXE)
        xxe: prevent
      
      # API Protection (OWASP API Top 10)
      apiProtection:
        enabled: true
        
        # Automatic API discovery
        apiDiscovery: true
        
        # Schema validation (enforce OpenAPI/Swagger spec)
        schemaValidation: prevent
        
        # BOLA (Broken Object Level Authorization) protection
        bola: prevent
        
        # BFLA (Broken Function Level Authorization) protection
        bfla: prevent
        
        # Excessive data exposure protection
        excessiveDataExposure: prevent
        
        # Resource consumption protection
        resourceConsumption: prevent
        
        # SSRF (Server-Side Request Forgery) protection
        ssrf: prevent
        
        # Fallback action for unknown endpoints
        fallbackEffect: alert
      
      # Rate Limiting Configuration
      rateLimiting:
        enabled: true
        
        # Global rate limit
        global:
          limit: 50000
          period: 1m
          burst: 60000
        
        # Per client IP
        perClient:
          limit: 100
          period: 1m
          burst: 150
          action: ban
          banDuration: 30m
        
        # Per API key
        perAPIKey:
          limit: 1000
          period: 1m
          burst: 1200
          action: throttle
        
        # Per authenticated user
        perUser:
          limit: 500
          period: 1m
          requireAuthentication: true
        
        # Per endpoint (granular control)
        perEndpoint:
          - path: /api/v2/search
            limit: 50
            period: 1m
            action: throttle
          
          - path: /api/v2/export
            limit: 10
            period: 1h
            action: alert
          
          - path: /api/v2/ml/inference
            limit: 20
            period: 1m
            costMultiplier: 5
        
        # Adaptive rate limiting based on baseline
        adaptiveRateLimiting:
          enabled: true
          baselineWindow: 7d
          anomalyThreshold: 200%
        
        # Bypass rules for internal traffic
        bypassRules:
          - sourceIP: 10.0.0.0/8
            reason: internal-network
          - userAgent: HealthCheck/*
            paths:
              - /health
              - /ready
              - /healthz
      
      # Bot Protection
      botProtection:
        enabled: true
        
        # Detection mode: detect, challenge, block
        mode: challenge
        
        # Known good bots (search engines, monitoring)
        knownBots: allow
        
        # Unknown/suspicious bots
        unknownBots: prevent
        
        # JavaScript challenge for suspicious traffic
        javascriptChallenge: true
        
        # CAPTCHA configuration
        captcha:
          enabled: false
          provider: recaptcha
          siteKey: ""
          secretKey: ""
        
        # Session validation
        sessionValidation: true
        
        # Browser fingerprinting
        browserFingerprinting: true
      
      # Access Control
      accessControl:
        enabled: true
        
        # IP allowlist (empty = allow all)
        allowedIPs: []
        
        # IP blocklist
        deniedIPs:
          - 192.0.2.0/24
        
        # Geographic restrictions
        allowedCountries: []
        
        deniedCountries:
          - KP  # North Korea
          - IR  # Iran
          - SY  # Syria
        
        # User agent filtering
        deniedUserAgents:
          - sqlmap
          - nikto
          - nmap
      
      # Custom Rules
      customRules:
        - name: detect-api-key-in-url
          description: Block API keys exposed in URL parameters
          enabled: true
          pattern: "[?&]api[_-]?key=[a-zA-Z0-9]{20,}"
          scope: url
          action: prevent
          severity: high
        
        - name: detect-credit-cards
          description: Detect credit card numbers in responses
          enabled: true
          pattern: "\\b\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}\\b"
          scope: response
          action: alert
          severity: high
        
        - name: sensitive-path-protection
          description: Protect sensitive administrative paths
          enabled: true
          paths:
            - /admin
            - /debug
            - /.env
            - /config
          action: prevent
          methods: ["*"]
        
        - name: prevent-directory-traversal
          description: Block directory traversal attempts
          enabled: true
          pattern: "(\\.\\./|\\.\\.\\\\)"
          scope: url
          action: prevent
          severity: critical
      
      # Security Headers
      securityHeaders:
        enforcement:
          enabled: true
          action: inject
        
        requiredHeaders:
          response:
            Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
            X-Content-Type-Options: "nosniff"
            X-Frame-Options: "DENY"
            X-XSS-Protection: "1; mode=block"
            Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
            Referrer-Policy: "strict-origin-when-cross-origin"
            Permissions-Policy: "geolocation=(), microphone=(), camera=()"
        
        removeHeaders:
          - X-Powered-By
          - Server
          - X-AspNet-Version
          - X-AspNetMvc-Version
        
        corsConfiguration:
          validateOrigin: true
          allowedOrigins:
            - https://app.company.com
            - https://mobile.company.com
          denyWildcard: true
          allowCredentials: false
          maxAge: 3600
      
      # Authentication Validation
      authentication:
        jwt:
          enabled: true
          algorithms:
            - RS256
            - ES256
          issuer: "https://auth.company.com"
          audience: "api.company.com"
          strictValidation: true
          validateExpiration: true
          clockSkewTolerance: 30s
          requiredClaims:
            - sub
            - exp
            - iat
        
        oauth:
          enabled: true
          validateScopes: true
          requiredScopes:
            - api:read
            - api:write
      
      # Authorization Controls
      authorization:
        objectLevelAccess:
          enabled: true
          requireOwnership: true
          ownershipClaim: sub
        
        functionLevelAccess:
          enabled: true
          roleBasedAccess: true
          roleClaim: role
      
      # Advanced Protection
      advancedProtection:
        enabled: true
        effect: alert
        
        # Intelligence-based detection
        intelligenceSources: true
        
        # Behavioral modeling
        behavioralModeling: true
        
        # Anomaly detection
        anomalyDetection: true
      
      # DoS Protection
      dos:
        enabled: true
        burstSize: 500
        averageRate: 100
        action: ban
        banDuration: 1h
      
      # SSRF Protection (detailed)
      ssrfProtection:
        enabled: true
        
        urlValidation:
          allowedDomains:
            - api.trusted-partner.com
            - cdn.company.com
          allowedSchemes:
            - https
          denyPrivateIPs: true
          denyLoopback: true
          denyLinkLocal: true
          denyMulticast: true
        
        blockedDestinations:
          privateIPRanges:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
            - 127.0.0.0/8
          metadataEndpoints:
            - 169.254.169.254/32
            - 169.254.169.253/32
        
        protectedParameters:
          - url
          - callback_url
          - webhook
          - redirect_uri
          - image_url
          - fetch_url
  
  # Monitoring and Alerting
  monitoring:
    enabled: true
    realTimeAlerts: true
    detailedLogging: true
    auditTrail: comprehensive
  
  # Alert Configuration
  alerting:
    channels:
      - type: slack
        webhook: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
        severity:
          - critical
          - high
        
      - type: email
        recipients:
          - security-team@company.com
          - soc@company.com
        severity:
          - critical
          - high
          - medium
      
      - type: pagerduty
        serviceKey: "YOUR_PAGERDUTY_SERVICE_KEY"
        severity:
          - critical
      
      - type: syslog
        endpoint: "siem.company.com:514"
        protocol: tcp
        severity:
          - critical
          - high
          - medium
          - low
  
  # Compliance Frameworks
  compliance:
    frameworks:
      - owasp_api_top10_2023
      - owasp_top10_2021
      - pci_dss_4.0
      - hipaa
      - gdpr
      - csa_ccm_v4
    
    autoRemediate: true
    auditTrail: enabled
    evidenceCollection: true
  
  # Logging Configuration
  logging:
    enabled: true
    verbosity: detailed
    retention: 90d
    
    waasAuditLogs:
      enabled: true
      includePayload: true
      redactSensitive: true
    
    attackLogs:
      enabled: true
      includeFullRequest: true
      includeResponse: false
    
    accessLogs:
      enabled: true
      sampling: 100
      format: json
    
    destinations:
      - type: s3
        bucket: "s3://company-logs/waas/"
        encryption: AES256
      
      - type: cloudwatch
        logGroup: "/prisma-cloud/waas"
        region: us-east-1

# Notes:
# 1. Replace placeholder values (webhooks, emails, keys) with actual values
# 2. Adjust rate limits based on your traffic patterns
# 3. Test in non-production environment first
# 4. Monitor false positives and tune accordingly
# 5. Keep this file in version control
# 6. Review and update quarterly or after security incidents
