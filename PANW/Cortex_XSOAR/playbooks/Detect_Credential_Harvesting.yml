id: Detect_Credential_Harvesting
version: -1
name: Detect Credential Harvesting (T1003.001, T1003.002, T1555.003)
description: Sub-playbook to detect credential harvesting activities using Cortex XDR XQL queries. Maps to MITRE ATT&CK T1003.001 (LSASS Memory), T1003.002 (SAM), T1555.003 (Browser Credentials).
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: "0"
    type: start
    task:
      id: "0"
      name: Start Detection
      description: Start credential harvesting detection
      type: start
      iscommand: false
      brand: ""
      version: -1
    nexttasks:
      '#none#':
        - "1"
    view: |-
      {
        "position": {
          "x": 50,
          "y": 50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "1":
    id: "1"
    taskid: "1"
    type: regular
    task:
      id: "1"
      name: Execute XQL - LSASS Memory Access
      description: Execute XQL query to detect LSASS memory access (Mimikatz-like activity)
      type: regular
      script: ""
      scriptarguments:
        query: |-
          dataset = xdr_data
          | filter event_type = PROCESS
          | filter action_process_image_name = "lsass.exe"
          | filter action_parent_process_image_name != "winlogon.exe"
          | filter action_parent_process_image_name != "services.exe"
          | fields event_time_ts, action_parent_process_image_name, action_parent_process_command_line,
                  actor_primary_user_sid, action_process_image_path, action_process_pid
          | sort event_time_ts desc
        mitre_technique: "T1003.001"
        tactic: "Credential Access"
      brand: "CortexXDR"
      version: -1
    nexttasks:
      '#none#':
        - "2"
    view: |-
      {
        "position": {
          "x": 50,
          "y": 150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping: []
  "2":
    id: "2"
    taskid: "2"
    type: regular
    task:
      id: "2"
      name: Execute XQL - Credential Dumping Tools
      description: Execute XQL query to detect credential dumping tools execution
      type: regular
      script: ""
      scriptarguments:
        query: |-
          dataset = xdr_data
          | filter event_type = PROCESS
          | filter action_process_image_name in ("mimikatz.exe", "procdump.exe", "dumpcap.exe", 
                                                "wce.exe", "fgdump.exe", "gsecdump.exe", 
                                                "pwdump.exe", "quarkspwdump.exe")
          | fields event_time_ts, action_process_image_name, action_process_image_path,
                  action_process_command_line, actor_primary_user_sid, action_process_pid
          | sort event_time_ts desc
        mitre_technique: "T1003.001"
        tactic: "Credential Access"
      brand: "CortexXDR"
      version: -1
    nexttasks:
      '#none#':
        - "3"
    view: |-
      {
        "position": {
          "x": 50,
          "y": 250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping: []
  "3":
    id: "3"
    taskid: "3"
    type: regular
    task:
      id: "3"
      name: Execute XQL - Registry Access for Credentials
      description: Execute XQL query to detect registry access for credential storage
      type: regular
      script: ""
      scriptarguments:
        query: |-
          dataset = xdr_data
          | filter event_type = REGISTRY
          | filter action_registry_key_name contains "LSA"
          | filter action_registry_key_name contains "SAM"
          | filter action_registry_key_name contains "SECURITY"
          | filter action_registry_operation in ("RegOpenKey", "RegQueryValue", "RegSetValue")
          | fields event_time_ts, action_registry_key_name, action_registry_value_name,
                  action_registry_operation, actor_process_image_name, actor_primary_user_sid
          | sort event_time_ts desc
        mitre_technique: "T1003.002"
        tactic: "Credential Access"
      brand: "CortexXDR"
      version: -1
    nexttasks:
      '#none#':
        - "4"
    view: |-
      {
        "position": {
          "x": 50,
          "y": 350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping: []
  "4":
    id: "4"
    taskid: "4"
    type: regular
    task:
      id: "4"
      name: Execute XQL - Browser Credential Extraction
      description: Execute XQL query to detect browser credential extraction
      type: regular
      script: ""
      scriptarguments:
        query: |-
          dataset = xdr_data
          | filter event_type = FILE
          | filter action_file_path like "%\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data%"
          | filter action_file_path like "%\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles%\\logins.json%"
          | filter action_file_path like "%\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\Login Data%"
          | filter action_file_operation in ("FILE_WRITE", "FILE_READ")
          | fields event_time_ts, action_file_path, action_file_operation,
                  actor_process_image_name, actor_primary_user_sid
          | sort event_time_ts desc
        mitre_technique: "T1555.003"
        tactic: "Credential Access"
      brand: "CortexXDR"
      version: -1
    nexttasks:
      '#none#':
        - "5"
    view: |-
      {
        "position": {
          "x": 50,
          "y": 450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping: []
  "5":
    id: "5"
    taskid: "5"
    type: regular
    task:
      id: "5"
      name: Aggregate Results
      description: Aggregate and analyze all credential harvesting detection results
      type: regular
      script: ""
      brand: ""
      version: -1
    nexttasks:
      '#none#': []
    view: |-
      {
        "position": {
          "x": 50,
          "y": 550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping: []
inputs: []
outputs:
  - contextPath: CredentialHarvesting.Findings
    description: Detected credential harvesting findings
    type: string
  - contextPath: CredentialHarvesting.MitreTechniques
    description: MITRE ATT&CK technique IDs
    type: string
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 650,
        "width": 1850,
        "x": 0,
        "y": 0
      }
    }
  }
fromversion: "6.0.0"
toversion: "6.10.0"
